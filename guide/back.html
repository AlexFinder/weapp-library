<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>后端 | 在线借书平台</title>
    <meta name="description" content="一个连接读者与读书馆的图书资源共享平台">
    <link rel="icon" href="/weapp-libraryfavicon.ico">
    
    <link rel="preload" href="/weapp-library/assets/css/10.styles.393b12b7.css" as="style"><link rel="preload" href="/weapp-library/assets/js/app.2b25b6f9.js" as="script"><link rel="preload" href="/weapp-library/assets/js/6.738653b2.js" as="script"><link rel="prefetch" href="/weapp-library/assets/js/0.c24cc8e0.js"><link rel="prefetch" href="/weapp-library/assets/js/1.a506898e.js"><link rel="prefetch" href="/weapp-library/assets/js/2.0e148eba.js"><link rel="prefetch" href="/weapp-library/assets/js/3.5c6c8592.js"><link rel="prefetch" href="/weapp-library/assets/js/4.851e6de7.js"><link rel="prefetch" href="/weapp-library/assets/js/5.45b9bc90.js"><link rel="prefetch" href="/weapp-library/assets/js/7.431ab4d3.js"><link rel="prefetch" href="/weapp-library/assets/js/8.52e4b0e6.js"><link rel="prefetch" href="/weapp-library/assets/js/9.e291c1d7.js">
    <link rel="stylesheet" href="/weapp-library/assets/css/10.styles.393b12b7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/weapp-library/" class="home-link router-link-active"><!----><span class="site-name">
      在线借书平台
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/weapp-library/guide/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="https://github.com/imageslr/weapp-library" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小程序GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/imageslr/library-api" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/weapp-library/guide/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="https://github.com/imageslr/weapp-library" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小程序GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/imageslr/library-api" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>文档</span><!----></p><ul class="sidebar-group-items"><li><a href="/weapp-library/guide/" class="sidebar-link">快速了解</a></li><li><a href="/weapp-library/guide/feature.html" class="sidebar-link">功能</a></li><li><a href="/weapp-library/guide/install.html" class="sidebar-link">安装</a></li><li><a href="/weapp-library/guide/api.html" class="sidebar-link">API</a></li><li><a href="/weapp-library/guide/back.html" class="active sidebar-link">后端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/weapp-library/guide/back.html#系统架构" class="sidebar-link">系统架构</a></li><li class="sidebar-sub-header"><a href="/weapp-library/guide/back.html#安全机制" class="sidebar-link">安全机制</a></li><li class="sidebar-sub-header"><a href="/weapp-library/guide/back.html#数据库与模型类" class="sidebar-link">数据库与模型类</a></li><li class="sidebar-sub-header"><a href="/weapp-library/guide/back.html#参数校验、权限控制" class="sidebar-link">参数校验、权限控制</a></li><li class="sidebar-sub-header"><a href="/weapp-library/guide/back.html#错误处理" class="sidebar-link">错误处理</a></li><li class="sidebar-sub-header"><a href="/weapp-library/guide/back.html#文件结构" class="sidebar-link">文件结构</a></li></ul></li><li><a href="/weapp-library/guide/front.html" class="sidebar-link">前端</a></li><li><a href="/weapp-library/guide/config.html" class="sidebar-link">环境配置</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="后端"><a href="#后端" aria-hidden="true" class="header-anchor">#</a> 后端</h1><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Slim 文档：<a href="http://slim.lup5.com/docs/" target="_blank" rel="noopener noreferrer">点击查看<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>
Eloquent 文档：<a href="http://laravelacademy.org/post/8194.html" target="_blank" rel="noopener noreferrer">点击查看<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div><h2 id="系统架构"><a href="#系统架构" aria-hidden="true" class="header-anchor">#</a> 系统架构</h2><p>本项目采用三层架构，从上至下分为界面层、业务逻辑层(<code>Controller</code>)、数据访问层(<code>Eloquent\Model</code>)。通过 Slim 框架完全实现<strong>前后端分离</strong>，前后端通过<code>HTTPS</code>协议进行通信，传输数据格式为<code>JSON</code>。业务逻辑层提供了<a href="/weapp-library/guide/api.html">RESTful风格的API</a>。</p><p><strong>系统架构图</strong>：
<img src="/weapp-libraryassets/img/sys_architecture.3ec641c5.jpg" alt="系统架构图"></p><h2 id="安全机制"><a href="#安全机制" aria-hidden="true" class="header-anchor">#</a> 安全机制</h2><p>本项目采用<code>JWT</code>实现权限控制。用户权限验证流程如下：</p><ol><li>用户使用用户名密码请求服务器，服务器进行验证用户的信息，通过验证后返回给用户一个 token，失败时返回401错误</li><li>token 中携带了<code>user_type</code>，<code>user_id</code>等信息，设定了过期时间</li><li>客户端存储 token，之后访问每一个 API 时必须在<code>header</code>中添加<code>TOKEN</code>字段</li><li>服务器获得 token，检验是否合法；然后获取其中携带的用户信息，判断该用户是否有操作权限</li><li>若有操作权限，执行请求并返回数据；若 token 不合法或无操作权限，返回 403 错误</li></ol><h2 id="数据库与模型类"><a href="#数据库与模型类" aria-hidden="true" class="header-anchor">#</a> 数据库与模型类</h2><h3 id="命名规范"><a href="#命名规范" aria-hidden="true" class="header-anchor">#</a> 命名规范</h3><p>数据表命名遵守<code>Eloquent</code>默认命名规范：</p><ul><li>实体表：<code>Model</code>名（小写下划线，下同）的复数形式，如<code>wechat_users</code>, <code>books</code>, <code>booklists</code>，<code>libraries</code>等</li><li>关系表：<code>Model</code>名按首字母顺序用下划线连接，如<code>book_booklist</code>，<code>booklist_user</code>等</li><li>外键名：<code>Model</code>名+下划线+<code>id</code>，如<code>book_id</code>，<code>library_id</code>等</li></ul><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>如果不确定<code>Eloquent</code>的默认表名是什么，可以使用以下语句获取：</p><div class="language-PHP extra-class"><pre class="language-php"><code><span class="token function">str_plural</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'mouse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Mouse类对应的表名为mice</span>
</code></pre></div></div><h3 id="数据表"><a href="#数据表" aria-hidden="true" class="header-anchor">#</a> 数据表</h3><table><thead><tr><th>表名</th><th>描述</th></tr></thead><tbody><tr><td>books</td><td>图书信息</td></tr><tr><td>booklists</td><td>书单信息</td></tr><tr><td>book_booklist</td><td>书单内图书条目</td></tr><tr><td>booklist_wechat_user</td><td>书单-用户收藏关系</td></tr><tr><td>codes</td><td>验证码</td></tr><tr><td>classifications</td><td>中图法分类号</td></tr><tr><td>libraries</td><td>图书馆信息</td></tr><tr><td>orders</td><td>订单信息</td></tr><tr><td>reviews</td><td>图书评论</td></tr><tr><td>review_likes</td><td>评论点赞</td></tr><tr><td>tokens</td><td>token信息</td></tr><tr><td>wechat_users</td><td>微信小程序用户信息</td></tr></tbody></table><h3 id="表字段"><a href="#表字段" aria-hidden="true" class="header-anchor">#</a> 表字段</h3><ul><li>创建时间、更新时间：<code>created_at</code>、<code>updated_at</code></li><li>删除时间：<code>deleted_at</code>，默认<code>null</code>（见<a href="http://laravelacademy.org/post/1020.html" target="_blank" rel="noopener noreferrer">软删除<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</li></ul><p>数据库表结构与数据<code>.sql</code>文件见<a href="https://github.com/imageslr/library-api/tree/master/db/" target="_blank" rel="noopener noreferrer">github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，导入方式见<a href="/weapp-library/guide/install.html#创建数据库">创建数据库</a>。</p><h2 id="参数校验、权限控制"><a href="#参数校验、权限控制" aria-hidden="true" class="header-anchor">#</a> 参数校验、权限控制</h2><h3 id="aop-面向切面编程"><a href="#aop-面向切面编程" aria-hidden="true" class="header-anchor">#</a> AOP 面向切面编程</h3><p>Slim 框架提供了中间件功能，可以在 Controller 之前和之后运行代码。<strong>当中间件内抛出异常时，后续代码将不再执行，未捕获的异常将转入错误处理器；只有显式调用<code>$next($request, $response)</code>时才会执行后续代码</strong>。这就是参数校验和权限控制的原理。</p><p>本项目<strong>遵循单一职责原则</strong>，Controller 中的方法只与业务逻辑有关，其余操作如参数校验、权限控制等，均以中间件的形式添加到应用程序中。</p><h3 id="参数校验"><a href="#参数校验" aria-hidden="true" class="header-anchor">#</a> 参数校验</h3><p>本项目使用<a href="http://respect.github.io/Validation/" target="_blank" rel="noopener noreferrer"> Respect\Validation <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>校验参数，其优点是使用简单，可定制性高。<br>
在<a href="https://github.com/imageslr/library-api/tree/master/bootstrap/routes/modules/" target="_blank" rel="noopener noreferrer">定义一个路由<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的同时，为其添加<strong>参数校验中间件</strong>。以发表评论接口<code>POST /reviews</code>为例：</p><div class="language-PHP extra-class"><pre class="language-php"><code><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/reviews'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'ReviewController:addReviewByBookId'</span><span class="token punctuation">)</span>
  <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token variable">$next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$reviewInfo</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getParsedBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取参数对象</span>
      v<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">arrayType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">keySet</span><span class="token punctuation">(</span> 
          v<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'wechat_user_id'</span><span class="token punctuation">,</span> v<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">intVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// uid 必须为整数</span>
          v<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'score'</span><span class="token punctuation">,</span> v<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">intVal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">between</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 评分介于 1 ~ 10</span>
          v<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'content'</span><span class="token punctuation">,</span> v<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">stringType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">notEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 评论内容不能为空，最多 200 个字符</span>
      <span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'info'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$reviewInfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token variable">$next</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>add(...)</code>作用是为该 API 添加一个校验参数中间件，<code>v::arrayType-&gt;...-&gt;setName()</code>定义参数格式及参数名称，<code>check()</code>开始校验。当校验失败时，<code>check()</code>会抛出一个<code>ValidationException</code>异常，并附带错误信息，说明没有通过校验的参数名及期望的格式，见<a href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">错误处理</a>。</p><h3 id="权限控制"><a href="#权限控制" aria-hidden="true" class="header-anchor">#</a> 权限控制</h3><p>各个接口的权限控制主要有以下三种情况：</p><ul><li>只有登录后才能访问，如创建书单、发表书评</li><li>只允许特定类型用户访问，如只有超级管理员能获取所有用户信息</li><li>只有对应用户有操作权限，如修改用户信息<code>POST /users/{id}</code>，需要检验<code>token</code>中的<code>user_id</code></li></ul><p>同参数校验一样，在定义路由的同时为其添加<strong>权限控制中间件</strong>，各中间件定义在<a href="https://github.com/imageslr/library-api/tree/master/app/Middlewares/Auth.php" target="_blank" rel="noopener noreferrer"> Auth 类<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中，使用方法如下：</p><div class="language-PHP extra-class"><pre class="language-php"><code><span class="token comment">// 必须登录</span>
<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/reviews'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'ReviewController:addReviewByBookId'</span><span class="token punctuation">)</span>
  <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">add</span><span class="token punctuation">(</span>Auth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// 只能是小程序用户</span>
<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/reviews'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'ReviewController:addReviewByBookId'</span><span class="token punctuation">)</span>
  <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">add</span><span class="token punctuation">(</span>Auth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">wechatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// 只能是超级管理员</span>
<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/users'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'WechatUserController:getUsers'</span><span class="token punctuation">)</span>
  <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">add</span><span class="token punctuation">(</span>Auth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">adminType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// 可以是小程序用户或超级管理员</span>
<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/users'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'WechatUserController:createUser'</span><span class="token punctuation">)</span>
  <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">add</span><span class="token punctuation">(</span>Auth<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">multipleType</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'wechat'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'admin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// token 中的 user_id 与 path 中的 id 必须相同</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Authorization<span class="token punctuation">\</span>Authorization</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Exceptions<span class="token punctuation">\</span>AuthorizationException</span><span class="token punctuation">;</span>
<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'/users/{id}'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'WechatUserController:createUser'</span><span class="token punctuation">)</span>
  <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token variable">$next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token variable">$uidFromToken</span> <span class="token operator">=</span> Authorization<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getUserIdFromRequest</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$uidInPath</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">]</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$uidFromToken</span> <span class="token operator">!=</span> <span class="token variable">$uidInPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> AuthorizationException<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">denied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token variable">$next</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$response</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="错误处理"><a href="#错误处理" aria-hidden="true" class="header-anchor">#</a> 错误处理</h2><p>Slim 框架提供了全局的错误处理器用于接收所有未捕获的 PHP 异常。在 <a href="/weapp-library/guide/api.html#错误对象">API</a> 中提到过：所有错误情况<strong>一定会</strong>返回一个错误对象。因此，本项目定义了若干个异常类，用于封装错误代码<code>code</code>和错误消息<code>message</code>、<code>err_msg</code>。在<a href="https://github.com/imageslr/library-api/tree/master/bootstrap/error_handlers.php" target="_blank" rel="noopener noreferrer"> error_handlers.php <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中定义了多种错误处理器，用于捕获错误，返回错误对象。</p><h3 id="示例代码"><a href="#示例代码" aria-hidden="true" class="header-anchor">#</a> 示例代码</h3><p>下面的代码捕获<code>Respect\Validation</code>抛出的参数异常错误，返回 400 状态码与错误对象，错误对象中附带明确的错误说明信息：</p><div class="language-PHP extra-class"><pre class="language-php"><code><span class="token comment">// Validator 参数校验错误</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exception</span> <span class="token keyword">instanceof</span> <span class="token class-name">ValidationException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$c</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'response'</span><span class="token punctuation">]</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">withJson</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span>
          <span class="token constant">INVALID_PARAM</span><span class="token punctuation">,</span> 
          <span class="token variable">$exception</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="示例错误对象"><a href="#示例错误对象" aria-hidden="true" class="header-anchor">#</a> 示例错误对象</h3><p>以获取验证码接口<code>POST /codes</code>为例。该接口参数必须包含手机号<code>phone</code>。现在请求该接口，不附加任何参数，得到的服务器响应如下：</p><div class="language-JSON extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;参数校验错误&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;err_msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;phone 必须是一个11位中国大陆手机号&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个错误对象就是由上面示例代码中的<code>ValidationException</code>错误处理器返回的。</p><h2 id="文件结构"><a href="#文件结构" aria-hidden="true" class="header-anchor">#</a> 文件结构</h2><p><a href="https://github.com/imageslr/library-api" target="_blank" rel="noopener noreferrer">在 GitHub 上查看<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><div class="language- extra-class"><pre class="language-text"><code>.
├── app                   // 主目录
│   ├── Authorization     // 登录授权
│   ├── Controllers       // 业务逻辑控制器
│   ├── Exceptions        // 异常封装
│   ├── Helpers           
│   │   └── Message.php   // 短信发送
│   ├── Middlewares       // 中间件
│   │   ├── Auth.php      // 校验token
│   │   └── validateStartAndCount.php // 校验query中的start与count
│   ├── Models            // 模型类
│   ├── Validators        // Respect\Validation校验类
│   └── error_message.php // 错误信息文本定义
├── bootstrap             // 应用配置
│   ├── configuration.php // 配置项
│   ├── dependencies.php  // 数据库依赖
│   ├── error_handlers.php// 错误处理器
│   └── routes            // 路由配置
│       ├── index.php     
│       └── modules       // 各个模块下的路由
├── composer.json
├── composer.lock
├── vendor                // 依赖库
├── db                    // 数据库文件
│   ├── library_scheme.sql// 所有数据表结构
│   ├── library_data.sql  // 所有数据表数据
    └── ...               // 单个数据表的结构+数据
└── public
    └── index.php         // 入口文件
</code></pre></div></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/imageslr/library-api/edit/master/docs/guide/back.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/weapp-library/guide/api.html" class="prev">
          API
        </a></span><span class="next"><a href="/weapp-library/guide/front.html">
          前端
        </a> →
      </span></p></div></div></div></div>
    <script src="/weapp-library/assets/js/6.738653b2.js" defer></script><script src="/weapp-library/assets/js/app.2b25b6f9.js" defer></script>
  </body>
</html>
