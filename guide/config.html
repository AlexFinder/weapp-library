<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>环境配置 | 在线借书平台</title>
    <meta name="description" content="一个连接读者与读书馆的图书资源共享平台">
    <link rel="icon" href="/weapp-library/favicon.ico">
    
    <link rel="preload" href="/weapp-library/assets/css/10.styles.0987bdd5.css" as="style"><link rel="preload" href="/weapp-library/assets/js/app.e4437d2e.js" as="script"><link rel="preload" href="/weapp-library/assets/js/5.45b9bc90.js" as="script"><link rel="prefetch" href="/weapp-library/assets/js/0.c24cc8e0.js"><link rel="prefetch" href="/weapp-library/assets/js/1.a506898e.js"><link rel="prefetch" href="/weapp-library/assets/js/2.0e148eba.js"><link rel="prefetch" href="/weapp-library/assets/js/3.5c6c8592.js"><link rel="prefetch" href="/weapp-library/assets/js/4.851e6de7.js"><link rel="prefetch" href="/weapp-library/assets/js/6.738653b2.js"><link rel="prefetch" href="/weapp-library/assets/js/7.431ab4d3.js"><link rel="prefetch" href="/weapp-library/assets/js/8.52e4b0e6.js"><link rel="prefetch" href="/weapp-library/assets/js/9.e291c1d7.js">
    <link rel="stylesheet" href="/weapp-library/assets/css/10.styles.0987bdd5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/weapp-library/" class="home-link router-link-active"><!----><span class="site-name">
      在线借书平台
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/weapp-library/guide/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="https://github.com/imageslr/weapp-library" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小程序GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/imageslr/library-api" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/weapp-library/guide/" class="nav-link router-link-active">文档</a></div><div class="nav-item"><a href="https://github.com/imageslr/weapp-library" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小程序GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/imageslr/library-api" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>文档</span><!----></p><ul class="sidebar-group-items"><li><a href="/weapp-library/guide/" class="sidebar-link">快速了解</a></li><li><a href="/weapp-library/guide/feature.html" class="sidebar-link">功能</a></li><li><a href="/weapp-library/guide/install.html" class="sidebar-link">安装</a></li><li><a href="/weapp-library/guide/api.html" class="sidebar-link">API</a></li><li><a href="/weapp-library/guide/back.html" class="sidebar-link">后端</a></li><li><a href="/weapp-library/guide/front.html" class="sidebar-link">前端</a></li><li><a href="/weapp-library/guide/config.html" class="active sidebar-link">环境配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/weapp-library/guide/config.html#配置-https" class="sidebar-link">配置 HTTPS</a></li><li class="sidebar-sub-header"><a href="/weapp-library/guide/config.html#url-重写" class="sidebar-link">URL 重写</a></li><li class="sidebar-sub-header"><a href="/weapp-library/guide/config.html#两个域名共用一台服务器" class="sidebar-link">两个域名共用一台服务器</a></li><li class="sidebar-sub-header"><a href="/weapp-library/guide/config.html#同一个服务器，两个php版本" class="sidebar-link">同一个服务器，两个PHP版本</a></li><li class="sidebar-sub-header"><a href="/weapp-library/guide/config.html#完整配置文件" class="sidebar-link">完整配置文件</a></li></ul></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="环境配置"><a href="#环境配置" aria-hidden="true" class="header-anchor">#</a> 环境配置</h1><p>本项目服务器环境：Linux + Nginx + MySQL + PHP 7.0 / PHP 5.6。</p><h2 id="配置-https"><a href="#配置-https" aria-hidden="true" class="header-anchor">#</a> 配置 HTTPS</h2><p>小程序要求域名必须采用<code>HTTPS</code>协议。</p><ol><li>在<a href="https://qcloud.com" target="_blank" rel="noopener noreferrer">腾讯云<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>购买域名与服务器，完成备案</li><li>在腾讯云为域名<a href="https://console.cloud.tencent.com/ssl" target="_blank" rel="noopener noreferrer">申请SSL证书<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://console.cloud.tencent.com/ssl" target="_blank" rel="noopener noreferrer">下载<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>申请成功的证书，下载好的证书包含两个文件：<code>.key</code>与<code>.crt</code></li><li>在服务器的 Nginx 配置目录下新建一个目录<code>cert</code>（Ubuntu：<code>/etc/nginx/sites-available/default</code>），将这两个文件复制进去</li><li>配置文件<code>site.default</code>相关内容如下，具体值需要从腾讯云获取：</li></ol><div class="language- extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-text"><code>server {
    listen 443; # HTTPS 监听 443端口
    ssl on;
    ssl_certificate cert/xxxxxx.crt; # 这里填写你下载的 .crt 文件路径
    ssl_certificate_key cert/xxxxxx.key; # 这里填写你下载的 .key 文件路径
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;

    # ... 完整配置文件见下方
}
</code></pre></div><h2 id="url-重写"><a href="#url-重写" aria-hidden="true" class="header-anchor">#</a> URL 重写</h2><p>ThinkPHP 或 Slim 框架支持 RESTful API，但是必须通过它们的入口文件访问 API。例如，获取<code>id</code>为 1 的图书信息时，URL如下：</p><div class="language- extra-class"><pre class="language-text"><code>https://www.my-api-server.cn/api/public/index.php/api/v1/books/1
</code></pre></div><p>我们希望省略入口文件路径<code>/api/public/index.php</code>，以这样的方式访问 API：</p><div class="language- extra-class"><pre class="language-text"><code>https://www.my-api-server.cn/api/v1/books/1
</code></pre></div><p>配置文件相关内容如下：</p><div class="language- extra-class"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-text"><code>server {
    # ... 完整配置文件见下方

    location / {
        root   $root;
        index  index.html index.php;
        # 如果访问内容是文件，返回文件内容
        if ( -f $request_filename) {
            break; 
        }
        # 如果访问内容不是文件，则重定向至/api/index.php/$1，$1是所访问的URL
        # 如/api/v1/books/1会被重定向至/api/index.php/api/v1/books/1
        if ( !-e $request_filename) {
            rewrite ^(.*)$ /api/index.php/$1 last;
            break;
        }
    }

    # ... 完整配置文件见下方
}
</code></pre></div><h2 id="两个域名共用一台服务器"><a href="#两个域名共用一台服务器" aria-hidden="true" class="header-anchor">#</a> 两个域名共用一台服务器</h2><p>本项目共有两个版本的小程序，它们使用不同的域名。通过设置域名服务商的解析值，使两个域名指向一台服务器。通过在 Nginx 配置文件中添加<code>server</code>配置项即可支持多个域名：</p><div class="language- extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-text"><code># 第一个域名的配置
server {
    listen 443; 
    ssl on;
    ssl_certificate cert/xxxxxx.crt; # 第一个域名的 .crt 文件路径
    ssl_certificate_key cert/xxxxxx.key; # 第一个域名的 .key 文件路径
    server_name xxxxxx.cn; # 监听第一个域名

    # ... 完整配置文件见下方

    location / {
        # ... 完整配置文件见下方

        # 第一个域名的根目录是 /api
        if ( !-e $request_filename) {
            rewrite ^(.*)$ /api/index.php/$1 last;
            break;
        }
    }

    # ... 完整配置文件见下方
}

# 第二个域名的配置
server {
    listen 443; 
    ssl on;
    ssl_certificate cert/yyyyyy.crt; # 第二个域名的 .crt 文件路径
    ssl_certificate_key cert/yyyyyy.key; # 第二个域名的 .key 文件路径
    server_name yyyyyy.cn; # 监听第二个域名

    # ... 完整配置文件见下方

    location / {
        # ... 完整配置文件见下方

        # 第二个域名的根目录是 /old_api
        if ( !-e $request_filename) {
            rewrite ^(.*)$ /old_api/index.php/$1 last;
            break;
        }
    }

    # ... 完整配置文件见下方
}
</code></pre></div><h2 id="同一个服务器，两个php版本"><a href="#同一个服务器，两个php版本" aria-hidden="true" class="header-anchor">#</a> 同一个服务器，两个PHP版本</h2><p>上一节说过：本项目共有两个版本的小程序，它们使用不同的域名。同时，它们也使用不同的后台框架：“在线借书平台”使用 Slim + PHP 7.0，另一个小程序使用 ThinkPHP  + PHP 5.6。因此，我们需要在不同的域名下使用不同版本的 PHP 解释器。</p><p>配置步骤如下：</p><ol><li>安装 PHP 5.6、php5.6-fpm、PHP 7.0、php7.0-fpm</li><li>设置 php5.6-fpm 监听 9000 端口（默认），php7.0-fpm 监听 9001 端口</li><li>为不同域名使用不同版本的 php-fpm，配置文件相关内容如下：</li></ol><div class="language- extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-text"><code># 第一个域名的配置
server {
    # ... 完整配置文件见下方

    location ~ [^/]\.php(/|$) {
        # 域名1的 PHP 版本为 7.0
        # 这么写也可以：fastcgi_pass  127.0.0.1:9001; 
        fastcgi_pass  unix:/run/php/php7.0-fpm.sock; 

        # ... 完整配置文件见下方
    }

    # ... 完整配置文件见下方
}

# 第二个域名的配置
server {
    # ... 完整配置文件见下方

    location ~ [^/]\.php(/|$) {
        # 域名2的 PHP 版本为 5.6
        fastcgi_pass  127.0.0.1:9000; 

        # ... 完整配置文件见下方
    }

    # ... 完整配置文件见下方
}
</code></pre></div><h2 id="完整配置文件"><a href="#完整配置文件" aria-hidden="true" class="header-anchor">#</a> 完整配置文件</h2><div class="language- extra-class"><pre class="language-text"><code># 第一个域名的配置
server {
    listen 443;
    ssl on;
    ssl_certificate cert/domain-name-1.cn_bundle.crt; # 域名1 .crt 文件路径
    ssl_certificate_key cert/domain-name-1.cn.key; # 域名1 .key 文件路径
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    
    set $root /usr/share/nginx/html; # 网站根目录
    error_log /usr/share/nginx/html/nginx.error.log;
    access_log /usr/share/nginx/html/nginx.access.log;
    index index.html index.htm index.php;

    server_name domain-name-1.cn; # 域名1
    client_max_body_size 50M;

    location / {
        root   $root;
        index  index.html index.php;
        if ( -f $request_filename) {
            break;
        }
        if ( !-e $request_filename) {
            rewrite ^(.*)$ /api/index.php/$1 last; # 域名1的入口文件
            break;
        }
    }

    location ~ [^/]\.php(/|$) {
        #listen unix socket
        #fastcgi_pass  unix:/tmp/php-cgi.sock;
        #listen tcp socket

        fastcgi_pass  unix:/run/php/php7.0-fpm.sock; # 域名1的 PHP 版本为 7.0

        #pathinfo
        fastcgi_split_path_info ^((?U).+.php)(/?.+)$;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
        fastcgi_param    SCRIPT_FILENAME    $root$fastcgi_script_name;
        include        fastcgi_params;
    }
}

# 第二个域名的配置
server {
    listen 443;
    ssl on;
    ssl_certificate cert/domain-name-2.pem; # 域名2 .crt 文件路径
    ssl_certificate_key cert/domain-name-2.key; # 域名2 .crt 文件路径
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    
    set $root /usr/share/nginx/html;
    error_log /usr/share/nginx/html/nginx.error.log;
    access_log /usr/share/nginx/html/nginx.access.log;
    index index.html index.htm index.php;

    server_name domain-name-2.cn; # 域名2
    client_max_body_size 50M;

    location / {
        root   $root;
        index  index.html index.php;
        if ( -f $request_filename) {
            break;
        }
        if ( !-e $request_filename) {
            rewrite ^(.*)$ /old_api/index.php/$1 last; # 域名2的入口文件
            break;
        }
    }

    location ~ [^/]\.php(/|$) {
        #listen unix socket
        #fastcgi_pass  unix:/tmp/php-cgi.sock;
        #listen tcp socket

        fastcgi_pass  127.0.0.1:9000; # 域名2的 PHP 版本为 5.6

        #pathinfo
        fastcgi_split_path_info ^((?U).+.php)(/?.+)$;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;
        fastcgi_param    SCRIPT_FILENAME    $root$fastcgi_script_name;
        include        fastcgi_params;
    }
}
</code></pre></div></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/imageslr/library-api/edit/master/docs/guide/config.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="last-updated"><span class="prefix">上次更新: </span><span class="time">9/30/2018, 8:22:21 PM</span></div></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/weapp-library/guide/front.html" class="prev">
          前端
        </a></span><!----></p></div></div></div></div>
    <script src="/weapp-library/assets/js/5.45b9bc90.js" defer></script><script src="/weapp-library/assets/js/app.e4437d2e.js" defer></script>
  </body>
</html>
