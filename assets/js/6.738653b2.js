(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{152:function(t,s,a){t.exports=a.p+"assets/img/sys_architecture.3ec641c5.jpg"},239:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"后端"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#后端","aria-hidden":"true"}},[this._v("#")]),this._v(" 后端")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"系统架构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#系统架构","aria-hidden":"true"}},[this._v("#")]),this._v(" 系统架构")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("系统架构图")]),this._v("：\n"),s("img",{attrs:{src:a(152),alt:"系统架构图"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"安全机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全机制","aria-hidden":"true"}},[this._v("#")]),this._v(" 安全机制")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("本项目采用"),s("code",[this._v("JWT")]),this._v("实现权限控制。用户权限验证流程如下：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ol",[a("li",[t._v("用户使用用户名密码请求服务器，服务器进行验证用户的信息，通过验证后返回给用户一个 token，失败时返回401错误")]),a("li",[t._v("token 中携带了"),a("code",[t._v("user_type")]),t._v("，"),a("code",[t._v("user_id")]),t._v("等信息，设定了过期时间")]),a("li",[t._v("客户端存储 token，之后访问每一个 API 时必须在"),a("code",[t._v("header")]),t._v("中添加"),a("code",[t._v("TOKEN")]),t._v("字段")]),a("li",[t._v("服务器获得 token，检验是否合法；然后获取其中携带的用户信息，判断该用户是否有操作权限")]),a("li",[t._v("若有操作权限，执行请求并返回数据；若 token 不合法或无操作权限，返回 403 错误")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"数据库与模型类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据库与模型类","aria-hidden":"true"}},[this._v("#")]),this._v(" 数据库与模型类")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"命名规范"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#命名规范","aria-hidden":"true"}},[this._v("#")]),this._v(" 命名规范")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("数据表命名遵守"),s("code",[this._v("Eloquent")]),this._v("默认命名规范：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ul",[a("li",[t._v("实体表："),a("code",[t._v("Model")]),t._v("名（小写下划线，下同）的复数形式，如"),a("code",[t._v("wechat_users")]),t._v(", "),a("code",[t._v("books")]),t._v(", "),a("code",[t._v("booklists")]),t._v("，"),a("code",[t._v("libraries")]),t._v("等")]),a("li",[t._v("关系表："),a("code",[t._v("Model")]),t._v("名按首字母顺序用下划线连接，如"),a("code",[t._v("book_booklist")]),t._v("，"),a("code",[t._v("booklist_user")]),t._v("等")]),a("li",[t._v("外键名："),a("code",[t._v("Model")]),t._v("名+下划线+"),a("code",[t._v("id")]),t._v("，如"),a("code",[t._v("book_id")]),t._v("，"),a("code",[t._v("library_id")]),t._v("等")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"tip custom-block"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),a("p",[t._v("如果不确定"),a("code",[t._v("Eloquent")]),t._v("的默认表名是什么，可以使用以下语句获取：")]),a("div",{staticClass:"language-PHP extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{attrs:{class:"token function"}},[t._v("str_plural")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'mouse'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("// Mouse类对应的表名为mice")]),t._v("\n")])])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"数据表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据表","aria-hidden":"true"}},[this._v("#")]),this._v(" 数据表")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("table",[a("thead",[a("tr",[a("th",[t._v("表名")]),a("th",[t._v("描述")])])]),a("tbody",[a("tr",[a("td",[t._v("books")]),a("td",[t._v("图书信息")])]),a("tr",[a("td",[t._v("booklists")]),a("td",[t._v("书单信息")])]),a("tr",[a("td",[t._v("book_booklist")]),a("td",[t._v("书单内图书条目")])]),a("tr",[a("td",[t._v("booklist_wechat_user")]),a("td",[t._v("书单-用户收藏关系")])]),a("tr",[a("td",[t._v("codes")]),a("td",[t._v("验证码")])]),a("tr",[a("td",[t._v("classifications")]),a("td",[t._v("中图法分类号")])]),a("tr",[a("td",[t._v("libraries")]),a("td",[t._v("图书馆信息")])]),a("tr",[a("td",[t._v("orders")]),a("td",[t._v("订单信息")])]),a("tr",[a("td",[t._v("reviews")]),a("td",[t._v("图书评论")])]),a("tr",[a("td",[t._v("review_likes")]),a("td",[t._v("评论点赞")])]),a("tr",[a("td",[t._v("tokens")]),a("td",[t._v("token信息")])]),a("tr",[a("td",[t._v("wechat_users")]),a("td",[t._v("微信小程序用户信息")])])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"表字段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#表字段","aria-hidden":"true"}},[this._v("#")]),this._v(" 表字段")])},function(){var t=this.$createElement,s=this._self._c||t;return s("li",[this._v("创建时间、更新时间："),s("code",[this._v("created_at")]),this._v("、"),s("code",[this._v("updated_at")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"参数校验、权限控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数校验、权限控制","aria-hidden":"true"}},[this._v("#")]),this._v(" 参数校验、权限控制")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"aop-面向切面编程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#aop-面向切面编程","aria-hidden":"true"}},[this._v("#")]),this._v(" AOP 面向切面编程")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("Slim 框架提供了中间件功能，可以在 Controller 之前和之后运行代码。"),s("strong",[this._v("当中间件内抛出异常时，后续代码将不再执行，未捕获的异常将转入错误处理器；只有显式调用"),s("code",[this._v("$next($request, $response)")]),this._v("时才会执行后续代码")]),this._v("。这就是参数校验和权限控制的原理。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("本项目"),s("strong",[this._v("遵循单一职责原则")]),this._v("，Controller 中的方法只与业务逻辑有关，其余操作如参数校验、权限控制等，均以中间件的形式添加到应用程序中。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"参数校验"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数校验","aria-hidden":"true"}},[this._v("#")]),this._v(" 参数校验")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-PHP extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{attrs:{class:"token variable"}},[t._v("$this")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("post")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'/reviews'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'ReviewController:addReviewByBookId'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("add")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$request")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$response")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$next")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{attrs:{class:"token variable"}},[t._v("$reviewInfo")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$request")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("getParsedBody")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("// 获取参数对象")]),t._v("\n      v"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("arrayType")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("keySet")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" \n          v"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("key")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'wechat_user_id'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("intVal")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("// uid 必须为整数")]),t._v("\n          v"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("key")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'score'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("intVal")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("between")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("10")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("// 评分介于 1 ~ 10")]),t._v("\n          v"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("key")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'content'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("stringType")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("notEmpty")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("length")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("1")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("200")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token comment"}},[t._v("// 评论内容不能为空，最多 200 个字符")]),t._v("\n      "),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("setName")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'info'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("check")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$reviewInfo")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$next")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$request")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$response")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[a("code",[t._v("add(...)")]),t._v("作用是为该 API 添加一个校验参数中间件，"),a("code",[t._v("v::arrayType->...->setName()")]),t._v("定义参数格式及参数名称，"),a("code",[t._v("check()")]),t._v("开始校验。当校验失败时，"),a("code",[t._v("check()")]),t._v("会抛出一个"),a("code",[t._v("ValidationException")]),t._v("异常，并附带错误信息，说明没有通过校验的参数名及期望的格式，见"),a("a",{attrs:{href:"#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"}},[t._v("错误处理")]),t._v("。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"权限控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#权限控制","aria-hidden":"true"}},[this._v("#")]),this._v(" 权限控制")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ul",[a("li",[t._v("只有登录后才能访问，如创建书单、发表书评")]),a("li",[t._v("只允许特定类型用户访问，如只有超级管理员能获取所有用户信息")]),a("li",[t._v("只有对应用户有操作权限，如修改用户信息"),a("code",[t._v("POST /users/{id}")]),t._v("，需要检验"),a("code",[t._v("token")]),t._v("中的"),a("code",[t._v("user_id")])])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-PHP extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("// 必须登录")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$this")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("post")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'/reviews'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'ReviewController:addReviewByBookId'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("add")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Auth"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("validate")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 只能是小程序用户")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$this")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("post")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'/reviews'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'ReviewController:addReviewByBookId'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("add")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Auth"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("wechatType")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 只能是超级管理员")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$this")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("get")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'/users'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'WechatUserController:getUsers'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("add")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Auth"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("adminType")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// 可以是小程序用户或超级管理员")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$this")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("post")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'/users'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'WechatUserController:createUser'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("add")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Auth"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("multipleType")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'wechat'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'admin'")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n\n"),a("span",{attrs:{class:"token comment"}},[t._v("// token 中的 user_id 与 path 中的 id 必须相同")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),a("span",{attrs:{class:"token package"}},[t._v("App"),a("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Authorization"),a("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Authorization")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("use")]),t._v(" "),a("span",{attrs:{class:"token package"}},[t._v("App"),a("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Exceptions"),a("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("AuthorizationException")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token variable"}},[t._v("$this")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("post")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'/users/{id}'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'WechatUserController:createUser'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("add")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$request")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$response")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$next")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{attrs:{class:"token variable"}},[t._v("$uidFromToken")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" Authorization"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("getUserIdFromRequest")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$request")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{attrs:{class:"token variable"}},[t._v("$uidInPath")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$request")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("getAttributes")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'id'")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$uidFromToken")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$uidInPath")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" AuthorizationException"),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{attrs:{class:"token function"}},[t._v("denied")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$next")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$request")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$response")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"错误处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#错误处理","aria-hidden":"true"}},[this._v("#")]),this._v(" 错误处理")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"示例代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例代码","aria-hidden":"true"}},[this._v("#")]),this._v(" 示例代码")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("下面的代码捕获"),s("code",[this._v("Respect\\Validation")]),this._v("抛出的参数异常错误，返回 400 状态码与错误对象，错误对象中附带明确的错误说明信息：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-PHP extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{attrs:{class:"token comment"}},[t._v("// Validator 参数校验错误")]),t._v("\n"),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$exception")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("ValidationException")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$c")]),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'response'")]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("withStatus")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token number"}},[t._v("400")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("withJson")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("BadRequestException")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          "),a("span",{attrs:{class:"token constant"}},[t._v("INVALID_PARAM")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n          "),a("span",{attrs:{class:"token variable"}},[t._v("$exception")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("getMessage")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h3",{attrs:{id:"示例错误对象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例错误对象","aria-hidden":"true"}},[this._v("#")]),this._v(" 示例错误对象")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("以获取验证码接口"),s("code",[this._v("POST /codes")]),this._v("为例。该接口参数必须包含手机号"),s("code",[this._v("phone")]),this._v("。现在请求该接口，不附加任何参数，得到的服务器响应如下：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-JSON extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token property"}},[t._v('"code"')]),a("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("400")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{attrs:{class:"token property"}},[t._v('"message"')]),a("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v('"参数校验错误"')]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{attrs:{class:"token property"}},[t._v('"err_msg"')]),a("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{attrs:{class:"token string"}},[t._v('"phone 必须是一个11位中国大陆手机号"')]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("这个错误对象就是由上面示例代码中的"),s("code",[this._v("ValidationException")]),this._v("错误处理器返回的。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"文件结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#文件结构","aria-hidden":"true"}},[this._v("#")]),this._v(" 文件结构")])},function(){var t=this.$createElement,s=this._self._c||t;return s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[this._v(".\n├── app                   // 主目录\n│   ├── Authorization     // 登录授权\n│   ├── Controllers       // 业务逻辑控制器\n│   ├── Exceptions        // 异常封装\n│   ├── Helpers           \n│   │   └── Message.php   // 短信发送\n│   ├── Middlewares       // 中间件\n│   │   ├── Auth.php      // 校验token\n│   │   └── validateStartAndCount.php // 校验query中的start与count\n│   ├── Models            // 模型类\n│   ├── Validators        // Respect\\Validation校验类\n│   └── error_message.php // 错误信息文本定义\n├── bootstrap             // 应用配置\n│   ├── configuration.php // 配置项\n│   ├── dependencies.php  // 数据库依赖\n│   ├── error_handlers.php// 错误处理器\n│   └── routes            // 路由配置\n│       ├── index.php     \n│       └── modules       // 各个模块下的路由\n├── composer.json\n├── composer.lock\n├── vendor                // 依赖库\n├── db                    // 数据库文件\n│   ├── library_scheme.sql// 所有数据表结构\n│   ├── library_data.sql  // 所有数据表数据\n    └── ...               // 单个数据表的结构+数据\n└── public\n    └── index.php         // 入口文件\n")])])])}],e=a(0),r=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),a("div",{staticClass:"tip custom-block"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),a("p",[t._v("Slim 文档："),a("a",{attrs:{href:"http://slim.lup5.com/docs/",target:"_blank",rel:"noopener noreferrer"}},[t._v("点击查看"),a("OutboundLink")],1),a("br"),t._v("\nEloquent 文档："),a("a",{attrs:{href:"http://laravelacademy.org/post/8194.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("点击查看"),a("OutboundLink")],1)])]),t._m(1),a("p",[t._v("本项目采用三层架构，从上至下分为界面层、业务逻辑层("),a("code",[t._v("Controller")]),t._v(")、数据访问层("),a("code",[t._v("Eloquent\\Model")]),t._v(")。通过 Slim 框架完全实现"),a("strong",[t._v("前后端分离")]),t._v("，前后端通过"),a("code",[t._v("HTTPS")]),t._v("协议进行通信，传输数据格式为"),a("code",[t._v("JSON")]),t._v("。业务逻辑层提供了"),a("router-link",{attrs:{to:"./api.html"}},[t._v("RESTful风格的API")]),t._v("。")],1),t._m(2),t._m(3),t._m(4),t._m(5),t._m(6),t._m(7),t._m(8),t._m(9),t._m(10),t._m(11),t._m(12),t._m(13),a("ul",[t._m(14),a("li",[t._v("删除时间："),a("code",[t._v("deleted_at")]),t._v("，默认"),a("code",[t._v("null")]),t._v("（见"),a("a",{attrs:{href:"http://laravelacademy.org/post/1020.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("软删除"),a("OutboundLink")],1),t._v(")")])]),a("p",[t._v("数据库表结构与数据"),a("code",[t._v(".sql")]),t._v("文件见"),a("a",{attrs:{href:"https://github.com/imageslr/library-api/tree/master/db/",target:"_blank",rel:"noopener noreferrer"}},[t._v("github"),a("OutboundLink")],1),t._v("，导入方式见"),a("router-link",{attrs:{to:"./install.html#创建数据库"}},[t._v("创建数据库")]),t._v("。")],1),t._m(15),t._m(16),t._m(17),t._m(18),t._m(19),a("p",[t._v("本项目使用"),a("a",{attrs:{href:"http://respect.github.io/Validation/",target:"_blank",rel:"noopener noreferrer"}},[t._v(" Respect\\Validation "),a("OutboundLink")],1),t._v("校验参数，其优点是使用简单，可定制性高。"),a("br"),t._v("\n在"),a("a",{attrs:{href:"https://github.com/imageslr/library-api/tree/master/bootstrap/routes/modules/",target:"_blank",rel:"noopener noreferrer"}},[t._v("定义一个路由"),a("OutboundLink")],1),t._v("的同时，为其添加"),a("strong",[t._v("参数校验中间件")]),t._v("。以发表评论接口"),a("code",[t._v("POST /reviews")]),t._v("为例：")]),t._m(20),t._m(21),t._m(22),a("p",[t._v("各个接口的权限控制主要有以下三种情况：")]),t._m(23),a("p",[t._v("同参数校验一样，在定义路由的同时为其添加"),a("strong",[t._v("权限控制中间件")]),t._v("，各中间件定义在"),a("a",{attrs:{href:"https://github.com/imageslr/library-api/tree/master/app/Middlewares/Auth.php",target:"_blank",rel:"noopener noreferrer"}},[t._v(" Auth 类"),a("OutboundLink")],1),t._v("中，使用方法如下：")]),t._m(24),t._m(25),a("p",[t._v("Slim 框架提供了全局的错误处理器用于接收所有未捕获的 PHP 异常。在 "),a("router-link",{attrs:{to:"./api.html#错误对象"}},[t._v("API")]),t._v(" 中提到过：所有错误情况"),a("strong",[t._v("一定会")]),t._v("返回一个错误对象。因此，本项目定义了若干个异常类，用于封装错误代码"),a("code",[t._v("code")]),t._v("和错误消息"),a("code",[t._v("message")]),t._v("、"),a("code",[t._v("err_msg")]),t._v("。在"),a("a",{attrs:{href:"https://github.com/imageslr/library-api/tree/master/bootstrap/error_handlers.php",target:"_blank",rel:"noopener noreferrer"}},[t._v(" error_handlers.php "),a("OutboundLink")],1),t._v("中定义了多种错误处理器，用于捕获错误，返回错误对象。")],1),t._m(26),t._m(27),t._m(28),t._m(29),t._m(30),t._m(31),t._m(32),t._m(33),a("p",[a("a",{attrs:{href:"https://github.com/imageslr/library-api",target:"_blank",rel:"noopener noreferrer"}},[t._v("在 GitHub 上查看"),a("OutboundLink")],1)]),t._m(34)])},n,!1,null,null,null);s.default=r.exports}}]);