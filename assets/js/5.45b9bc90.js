(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{236:function(t,e,s){"use strict";s.r(e);var n=s(0),i=Object(n.a)({},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"content"},[t._m(0),s("p",[t._v("本项目服务器环境：Linux + Nginx + MySQL + PHP 7.0 / PHP 5.6。")]),t._m(1),t._m(2),s("ol",[s("li",[t._v("在"),s("a",{attrs:{href:"https://qcloud.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("腾讯云"),s("OutboundLink")],1),t._v("购买域名与服务器，完成备案")]),s("li",[t._v("在腾讯云为域名"),s("a",{attrs:{href:"https://console.cloud.tencent.com/ssl",target:"_blank",rel:"noopener noreferrer"}},[t._v("申请SSL证书"),s("OutboundLink")],1)]),s("li",[s("a",{attrs:{href:"https://console.cloud.tencent.com/ssl",target:"_blank",rel:"noopener noreferrer"}},[t._v("下载"),s("OutboundLink")],1),t._v("申请成功的证书，下载好的证书包含两个文件："),s("code",[t._v(".key")]),t._v("与"),s("code",[t._v(".crt")])]),t._m(3),t._m(4)]),t._m(5),t._m(6),t._m(7),t._m(8),t._m(9),t._m(10),s("p",[t._v("配置文件相关内容如下：")]),t._m(11),t._m(12),t._m(13),t._m(14),t._m(15),s("p",[t._v("上一节说过：本项目共有两个版本的小程序，它们使用不同的域名。同时，它们也使用不同的后台框架：“在线借书平台”使用 Slim + PHP 7.0，另一个小程序使用 ThinkPHP  + PHP 5.6。因此，我们需要在不同的域名下使用不同版本的 PHP 解释器。")]),s("p",[t._v("配置步骤如下：")]),t._m(16),t._m(17),t._m(18),t._m(19)])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"环境配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#环境配置","aria-hidden":"true"}},[this._v("#")]),this._v(" 环境配置")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"配置-https"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-https","aria-hidden":"true"}},[this._v("#")]),this._v(" 配置 HTTPS")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("小程序要求域名必须采用"),e("code",[this._v("HTTPS")]),this._v("协议。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[this._v("在服务器的 Nginx 配置目录下新建一个目录"),e("code",[this._v("cert")]),this._v("（Ubuntu："),e("code",[this._v("/etc/nginx/sites-available/default")]),this._v("），将这两个文件复制进去")])},function(){var t=this.$createElement,e=this._self._c||t;return e("li",[this._v("配置文件"),e("code",[this._v("site.default")]),this._v("相关内容如下，具体值需要从腾讯云获取：")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("div",{staticClass:"highlight-lines"},[e("br"),e("br"),e("br"),e("div",{staticClass:"highlighted"},[this._v(" ")]),e("div",{staticClass:"highlighted"},[this._v(" ")]),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br")]),e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("server {\n    listen 443; # HTTPS 监听 443端口\n    ssl on;\n    ssl_certificate cert/xxxxxx.crt; # 这里填写你下载的 .crt 文件路径\n    ssl_certificate_key cert/xxxxxx.key; # 这里填写你下载的 .key 文件路径\n    ssl_session_timeout 5m;\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_prefer_server_ciphers on;\n\n    # ... 完整配置文件见下方\n}\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"url-重写"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#url-重写","aria-hidden":"true"}},[this._v("#")]),this._v(" URL 重写")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("ThinkPHP 或 Slim 框架支持 RESTful API，但是必须通过它们的入口文件访问 API。例如，获取"),e("code",[this._v("id")]),this._v("为 1 的图书信息时，URL如下：")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("https://www.my-api-server.cn/api/public/index.php/api/v1/books/1\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("我们希望省略入口文件路径"),e("code",[this._v("/api/public/index.php")]),this._v("，以这样的方式访问 API：")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("https://www.my-api-server.cn/api/v1/books/1\n")])])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language- extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("server {\n    # ... 完整配置文件见下方\n\n    location / {\n        root   $root;\n        index  index.html index.php;\n        # 如果访问内容是文件，返回文件内容\n        if ( -f $request_filename) {\n            break; \n        }\n        # 如果访问内容不是文件，则重定向至/api/index.php/$1，$1是所访问的URL\n        # 如/api/v1/books/1会被重定向至/api/index.php/api/v1/books/1\n        if ( !-e $request_filename) {\n            rewrite ^(.*)$ /api/index.php/$1 last;\n            break;\n        }\n    }\n\n    # ... 完整配置文件见下方\n}\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"两个域名共用一台服务器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#两个域名共用一台服务器","aria-hidden":"true"}},[this._v("#")]),this._v(" 两个域名共用一台服务器")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("本项目共有两个版本的小程序，它们使用不同的域名。通过设置域名服务商的解析值，使两个域名指向一台服务器。通过在 Nginx 配置文件中添加"),e("code",[this._v("server")]),this._v("配置项即可支持多个域名：")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language- extra-class"},[s("div",{staticClass:"highlight-lines"},[s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("div",{staticClass:"highlighted"},[t._v(" ")]),s("br"),s("br"),s("br"),s("br"),s("br"),s("br"),s("br")]),s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# 第一个域名的配置\nserver {\n    listen 443; \n    ssl on;\n    ssl_certificate cert/xxxxxx.crt; # 第一个域名的 .crt 文件路径\n    ssl_certificate_key cert/xxxxxx.key; # 第一个域名的 .key 文件路径\n    server_name xxxxxx.cn; # 监听第一个域名\n\n    # ... 完整配置文件见下方\n\n    location / {\n        # ... 完整配置文件见下方\n\n        # 第一个域名的根目录是 /api\n        if ( !-e $request_filename) {\n            rewrite ^(.*)$ /api/index.php/$1 last;\n            break;\n        }\n    }\n\n    # ... 完整配置文件见下方\n}\n\n# 第二个域名的配置\nserver {\n    listen 443; \n    ssl on;\n    ssl_certificate cert/yyyyyy.crt; # 第二个域名的 .crt 文件路径\n    ssl_certificate_key cert/yyyyyy.key; # 第二个域名的 .key 文件路径\n    server_name yyyyyy.cn; # 监听第二个域名\n\n    # ... 完整配置文件见下方\n\n    location / {\n        # ... 完整配置文件见下方\n\n        # 第二个域名的根目录是 /old_api\n        if ( !-e $request_filename) {\n            rewrite ^(.*)$ /old_api/index.php/$1 last;\n            break;\n        }\n    }\n\n    # ... 完整配置文件见下方\n}\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"同一个服务器，两个php版本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#同一个服务器，两个php版本","aria-hidden":"true"}},[this._v("#")]),this._v(" 同一个服务器，两个PHP版本")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",[e("li",[this._v("安装 PHP 5.6、php5.6-fpm、PHP 7.0、php7.0-fpm")]),e("li",[this._v("设置 php5.6-fpm 监听 9000 端口（默认），php7.0-fpm 监听 9001 端口")]),e("li",[this._v("为不同域名使用不同版本的 php-fpm，配置文件相关内容如下：")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("div",{staticClass:"highlight-lines"},[e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("div",{staticClass:"highlighted"},[this._v(" ")]),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("div",{staticClass:"highlighted"},[this._v(" ")]),e("br"),e("br"),e("br"),e("br"),e("br"),e("br"),e("br")]),e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("# 第一个域名的配置\nserver {\n    # ... 完整配置文件见下方\n\n    location ~ [^/]\\.php(/|$) {\n        # 域名1的 PHP 版本为 7.0\n        # 这么写也可以：fastcgi_pass  127.0.0.1:9001; \n        fastcgi_pass  unix:/run/php/php7.0-fpm.sock; \n\n        # ... 完整配置文件见下方\n    }\n\n    # ... 完整配置文件见下方\n}\n\n# 第二个域名的配置\nserver {\n    # ... 完整配置文件见下方\n\n    location ~ [^/]\\.php(/|$) {\n        # 域名2的 PHP 版本为 5.6\n        fastcgi_pass  127.0.0.1:9000; \n\n        # ... 完整配置文件见下方\n    }\n\n    # ... 完整配置文件见下方\n}\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"完整配置文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#完整配置文件","aria-hidden":"true"}},[this._v("#")]),this._v(" 完整配置文件")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("# 第一个域名的配置\nserver {\n    listen 443;\n    ssl on;\n    ssl_certificate cert/domain-name-1.cn_bundle.crt; # 域名1 .crt 文件路径\n    ssl_certificate_key cert/domain-name-1.cn.key; # 域名1 .key 文件路径\n    ssl_session_timeout 5m;\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_prefer_server_ciphers on;\n    \n    set $root /usr/share/nginx/html; # 网站根目录\n    error_log /usr/share/nginx/html/nginx.error.log;\n    access_log /usr/share/nginx/html/nginx.access.log;\n    index index.html index.htm index.php;\n\n    server_name domain-name-1.cn; # 域名1\n    client_max_body_size 50M;\n\n    location / {\n        root   $root;\n        index  index.html index.php;\n        if ( -f $request_filename) {\n            break;\n        }\n        if ( !-e $request_filename) {\n            rewrite ^(.*)$ /api/index.php/$1 last; # 域名1的入口文件\n            break;\n        }\n    }\n\n    location ~ [^/]\\.php(/|$) {\n        #listen unix socket\n        #fastcgi_pass  unix:/tmp/php-cgi.sock;\n        #listen tcp socket\n\n        fastcgi_pass  unix:/run/php/php7.0-fpm.sock; # 域名1的 PHP 版本为 7.0\n\n        #pathinfo\n        fastcgi_split_path_info ^((?U).+.php)(/?.+)$;\n        fastcgi_param PATH_INFO $fastcgi_path_info;\n        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;\n        fastcgi_param    SCRIPT_FILENAME    $root$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n}\n\n# 第二个域名的配置\nserver {\n    listen 443;\n    ssl on;\n    ssl_certificate cert/domain-name-2.pem; # 域名2 .crt 文件路径\n    ssl_certificate_key cert/domain-name-2.key; # 域名2 .crt 文件路径\n    ssl_session_timeout 5m;\n    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n    ssl_prefer_server_ciphers on;\n    \n    set $root /usr/share/nginx/html;\n    error_log /usr/share/nginx/html/nginx.error.log;\n    access_log /usr/share/nginx/html/nginx.access.log;\n    index index.html index.htm index.php;\n\n    server_name domain-name-2.cn; # 域名2\n    client_max_body_size 50M;\n\n    location / {\n        root   $root;\n        index  index.html index.php;\n        if ( -f $request_filename) {\n            break;\n        }\n        if ( !-e $request_filename) {\n            rewrite ^(.*)$ /old_api/index.php/$1 last; # 域名2的入口文件\n            break;\n        }\n    }\n\n    location ~ [^/]\\.php(/|$) {\n        #listen unix socket\n        #fastcgi_pass  unix:/tmp/php-cgi.sock;\n        #listen tcp socket\n\n        fastcgi_pass  127.0.0.1:9000; # 域名2的 PHP 版本为 5.6\n\n        #pathinfo\n        fastcgi_split_path_info ^((?U).+.php)(/?.+)$;\n        fastcgi_param PATH_INFO $fastcgi_path_info;\n        fastcgi_param PATH_TRANSLATED $document_root$fastcgi_path_info;\n        fastcgi_param    SCRIPT_FILENAME    $root$fastcgi_script_name;\n        include        fastcgi_params;\n    }\n}\n")])])])}],!1,null,null,null);e.default=i.exports}}]);